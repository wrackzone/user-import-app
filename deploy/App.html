<!DOCTYPE html>
<html>
<head>
    <title>user-import-app</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null,console=window.console||{};console.log=console.log||Ext.emptyFn,console.dir=console.dir||Ext.emptyFn,console.error=console.error||Ext.emptyFn,Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{},margin:25,types:["User","UserProfile","WorkspacePermission","ProjectPermission"],blacklistFields:["ObjectID"],requiredFields:["UserName","EmailAddress"],specialFields:["WorkspacePermissions","ProjectPermissions","DefaultWorkspace","DefaultProject"],defaultBlankFields:["FirstName","MiddleName","LastName","OnpremLdapUsername"],customFields:[],fieldValues:{},launch:function(){app=this;var ff=Ext.create("Ext.form.field.File",{margin:10,id:"form-file",emptyText:"Select a CSV File",fieldLabel:"Upload File",name:"csv-path",buttonText:"Select",listeners:{afterrender:function(){var f=document.querySelector('input[type="file"]');app.addFileEvent(f)}},width:400,autoRender:!0});app.add(ff)},addFileEvent:function(f){f.addEventListener("change",function(){file=event.target.files[0];var reader=new FileReader;reader.onload=function(event){var csv=Ext.create("CsvParser",{csvString:event.target.result});app.addGrid(csv)},reader.onerror=function(){Ext.MessageBox.show({title:"File Error",msg:"Error loading file",buttons:Ext.MessageBox.OK}),console.error("On Error Event")},reader.readAsText(file)})},addGrid:function(csv){var items=csv.getAsJson(),columns=_.map(csv.getHeader(),function(k){return{text:k,dataIndex:k,flex:1,width:100}});void 0!==app.grid&&null!==app.grid&&app.grid.destroy(),Ext.create("Rally.data.custom.Store",{storeId:"csvStore",fields:csv.getHeader(),data:{items:items},proxy:{type:"memory",reader:{type:"json",root:"items"}}}),app.grid=Ext.create("Rally.ui.grid.Grid",{store:Ext.data.StoreManager.lookup("csvStore"),plugins:["rallycellediting"],enableEditing:!0,columnCfgs:columns,tbar:[{xtype:"tbfill"},{xtype:"rallybutton",text:"Validate",handler:app.doValidation},{xtype:"rallybutton",text:"Import",handler:app._import}]}),app.add(app.grid)},doValidation:function(){var headerPromise=app._validateHeaders();headerPromise.then(function(hasAllRequired){hasAllRequired&&app._validateRows()})},_validateRows:function(){var store=Ext.data.StoreManager.lookup("csvStore"),valid=!0;return store.each(function(row){var v=app._validateRow(row);valid=valid&&!!v.length}),valid},_validateRow:function(row){return _(app.fieldValues).map(function(fields,typeName){return _.map(fields,function(value,name){var f=row.get(name);return!f&&_.contains(app.customFields,name)&&(f=row.get(name.substring(2))),f?_.isArray(value)?_.contains(value,f)?null:name:"STRING"===value?255>f.length?null:name:"TEXT"===value?32535>f.length?null:name:"BOOLEAN"===value?_.isString(f)?"true"===f.toLowerCase()||"false"===f.toLowerCase()?null:name:_.isBoolean(f)?null:name:(console.log(name,f,value),null):null})}).flatten().unique().pull(null,void 0).value()},_validateHeaders:function(){var model=Ext.data.StoreManager.lookup("csvStore").first(),fields,promises=[],defer=Ext.create("Deft.promise.Deferred");return model?(fields=_.transform(model.data,function(res,f,k){res[k]=0}),Rally.data.ModelFactory.getModels({types:app.types,success:function(models){_.each(models,function(model,type){app.fieldValues[type]=app.fieldValues[type]||{},_.each(model.getFields(),function(f){f.attributeDefinition&&(app.fieldValues[type][f.name]=f.attributeDefinition.AttributeType,"User"!==type||"username"!==f.name.toLowerCase()&&"emailaddress"!==f.name.toLowerCase()||(app.fieldValues[type][f.name]="EMAIL"),console.log(f.name,app.fieldValues[type][f.name])),f.custom&&app.customFields.push(f.name),_.isArray(f.allowedValues)?f.allowedValues.length&&(app.fieldValues[type][f.name]=_.map(f.allowedValues,function(r){return r.StringValue})):_.isObject(f.allowedValues)&&function(name,type){promises.push(f.getAllowedValueStore().load().then(function(records){records.length&&(app.fieldValues[type][name]=_.map(records,function(r){return r.get("StringValue")}))}))}(f.name,type),fields.hasOwnProperty(f.name)&&(fields[f.name]=1),f.required&&f.creatable&&!_.contains(app.blacklistFields,f.name)&&app.requiredFields.push(f.name)})}),app.requiredFields=_.unique(app.requiredFields);var hasAllRequired=_.all(app.requiredFields,function(rf){return!!fields[rf]||_.contains(app.defaultBlankFields,rf)});Deft.Promise.all(promises).then(function(){defer.resolve(hasAllRequired)})}}),defer.promise):(defer.reject(Error("No data was loaded")),defer.promise)},_import:function(){}});
                Ext.define("CsvParser",function(){var self;return{config:{csvString:null},constructor:function(config){return self=this,this.initConfig(config),self.valid=!0,self.errors=[],self.csvArray=self.csvToArray(self.getCsvString()),this},isValid:function(){return self.valid},getErrors:function(){return self.errors},getHeader:function(){return self.header},csvToArray:function(csvString){var csvArray=[],csvRows=csvString.split(/[\r\n]/);console.log("rows",csvRows.length);for(var rowIndex=0;csvRows.length>rowIndex;rowIndex++){var rowArray=self.parseCsvRow(csvRows[rowIndex]);0===rowIndex?(self.header=rowArray,self.valid=self.header.length>0):null!==rowArray&&rowArray.length>0?csvArray.push(rowArray):self.errors.push(rowIndex+":"+csvRows[rowIndex])}return csvArray},parseCsvRow:function(text){var re_valid=/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/,re_value=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;if(!re_valid.test(text))return console.warn("CSVtoArray: Invalid csv text.\n\nSee http://stackoverflow.com/questions/8493195/how-can-i-parse-a-csv-string-with-javascript for help."),console.warn(text),null;var a=[];return text.replace(re_value,function(m0,m1,m2,m3){return void 0!==m1?a.push(m1.replace(/\\'/g,"'")):void 0!==m2?a.push(m2.replace(/\\"/g,'"')):void 0!==m3&&a.push(m3),""}),/,\s*$/.test(text)&&a.push(""),a},getAsJson:function(){if(!self.valid)return null;var csv=[];return _.each(self.csvArray,function(row,i){if(0!==i){var r={};_.each(self.header,function(cHeader,cIndex){r[cHeader]=row[cIndex]}),csv.push(r)}}),csv}}});

            Rally.launchApp('CustomApp', {
                name:"user-import-app",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
